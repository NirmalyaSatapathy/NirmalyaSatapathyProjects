package com.java.Carrental.bal;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

import com.java.Carrental.Exception.CarNotFoundException;
import com.java.Carrental.dao.PaymentsaoImp;
import com.java.Carrental.model.Payment;
import com.java.Carrental.util.ConnectionHelper;

public class Paymentsbal {
	Connection con;
	public String makePaymentbal(Payment payment) throws ClassNotFoundException, SQLException, CarNotFoundException
	{
		 StringBuilder errors = new StringBuilder();
		    if (payment.getPaymentId() <= 0) {
		        errors.append("Payment ID must be greater than 0.");
		    }
		    if (payment.getLeaseId() <= 0) {
		        errors.append("Lease ID must be greater than 0.");
		    }
		    if (!leaseExists(payment.getLeaseId())) {
		        errors.append("Lease with ID " + payment.getLeaseId() + " does not exist.");
		    }

		    if (payment.getAmount() <= 0) {//update it to check that paid amount is equal to cost or not
		        errors.append("Payment amount must be greater than 0.");
		    }
		    if (payment.getDate() == null) {
		        errors.append("Payment date cannot be null.\n");
		    }
		    double cost=getCost(payment.getLeaseId());
		    if(payment.getAmount()!=cost)
		    {
		    	errors.append("enter the expected amount i.e  "+cost);
		    }
		    if (errors.length() > 0) {
		        throw new CarNotFoundException(errors.toString());
		    }
			return new PaymentsaoImp().makePayment(payment);
	}
	public List<Payment> getPaymentsByLeaseId(int leaseId) throws ClassNotFoundException, SQLException, CarNotFoundException
	{
		 StringBuilder errors = new StringBuilder();
		if(!leaseExists(leaseId))
		{
			errors.append("Lease with ID " + leaseId + " does not exist.");
		}
		if (errors.length() > 0) {
	        throw new CarNotFoundException(errors.toString());
	    }
		return new PaymentsaoImp().getPaymentsByLeaseId(leaseId);
	}
	private double getCost(int leaseId) throws ClassNotFoundException, SQLException {
		// TODO Auto-generated method stub
			con = ConnectionHelper.getConnection();
		    String cmd = "SELECT cost FROM Lease WHERE leaseId = ?";
		    PreparedStatement ps = con.prepareStatement(cmd);
		    ps.setInt(1, leaseId);
		    ResultSet rs = ps.executeQuery();
		    return rs.getDouble("cost");
		    
	}
	public boolean leaseExists(int leaseId) throws ClassNotFoundException, SQLException
	{
		con=ConnectionHelper.getConnection();
		String cmd="select*from Lease where leaseId=?";
		PreparedStatement pst=con.prepareStatement(cmd);
		pst.setInt(1, leaseId);
		ResultSet rs=pst.executeQuery();
		return rs.next();
	}
}
